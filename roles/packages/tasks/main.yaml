---
- name: Install os packages
  become: yes
  ansible.builtin.package:
    name: "{{ packages }}"

- name: Install debian packages
  become: yes
  apt:
    deb: "{{ item }}"
    autoclean: yes
    autoremove: yes
  loop: "{{ debian_packages }}"

- name: Install binaries
  become: yes
  get_url:
    url: "{{ item.url }}"
    dest: /usr/local/bin/{{ item.name }}
    mode: '0755'
  loop: "{{ binaries }}"

- name: Install golangci-lint
  become: yes
  shell: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b /usr/local/bin

- name: Setup krew
  shell: |
    (
      set -x; cd "$(mktemp -d)" &&
      OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
      ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
      curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.tar.gz" &&
      tar zxvf krew.tar.gz &&
      KREW=./krew-"${OS}_${ARCH}" &&
      "$KREW" install krew
    )

- name: Install krew plugins
  command: kubectl krew install {{ item }}
  loop:
    - get-all
  environment:
    PATH: "{{ ansible_env.HOME }}/.krew/bin:{{ ansible_env.HOME }}/go/bin:{{ ansible_env.PATH }}"
